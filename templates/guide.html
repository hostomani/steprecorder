<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title }} - Documentation</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif; }
    .doc-step { counter-increment: step-counter; }
    .step-connector {
      position: absolute;
      left: 19px;
      top: 40px;
      bottom: -40px;
      width: 2px;
      background: #e5e7eb;
    }
    .step-node {
      position: relative;
      z-index: 1;
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600; font-size: 14px;
      background: #1e40af;
      color: white;
      flex-shrink: 0;
    }
    .doc-screenshot {
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
    }
    .screenshot-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .click-highlight {
      position: absolute;
      width: 10px; height: 10px;
      margin-left: -5px; margin-top: -5px;
      border-radius: 50%;
      background: #ef4444;
      pointer-events: none;
      animation: click-pulse 1.5s ease-out infinite;
    }
    @keyframes click-pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); transform: scale(1); }
      50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); transform: scale(1.2); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); transform: scale(1); }
    }

    /* Sidebar */
    .sidebar-left {
      position: sticky;
      top: 49px;
      height: calc(100vh - 49px);
      overflow-y: auto;
    }
    .sidebar-right {
      position: sticky;
      top: 49px;
      height: calc(100vh - 49px);
      overflow-y: auto;
    }
    .sidebar-left::-webkit-scrollbar,
    .sidebar-right::-webkit-scrollbar {
      width: 3px;
    }
    .sidebar-left::-webkit-scrollbar-thumb,
    .sidebar-right::-webkit-scrollbar-thumb {
      background: #e5e7eb;
      border-radius: 3px;
    }
    .guide-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      color: #6b7280;
      text-decoration: none;
      transition: background 0.15s, color 0.15s;
    }
    .guide-link:hover { background: #f3f4f6; color: #111827; }
    .guide-link.active { background: #eff6ff; color: #1e40af; font-weight: 500; }
    .toc-link {
      display: block;
      padding: 4px 12px;
      border-left: 2px solid transparent;
      font-size: 13px;
      color: #6b7280;
      text-decoration: none;
      transition: color 0.15s, border-color 0.15s;
    }
    .toc-link:hover { color: #1e40af; }
    .toc-link.active { color: #1e40af; border-left-color: #1e40af; font-weight: 500; }

    /* Rich text content */
    .rich-text p { margin: 0.25em 0; }
    .rich-text ul, .rich-text ol { margin: 0.25em 0; padding-left: 1.5em; }
    .rich-text ul { list-style: disc; }
    .rich-text ol { list-style: decimal; }
    .rich-text a { color: #2563eb; text-decoration: underline; }
    .rich-text pre { background: #f3f4f6; border-radius: 6px; padding: 0.75em 1em; font-size: 0.875em; overflow-x: auto; }
    .rich-text code { background: #f3f4f6; padding: 0.15em 0.3em; border-radius: 3px; font-size: 0.875em; }
    .rich-text pre code { background: none; padding: 0; }

    @media print {
      .no-print { display: none !important; }
      .doc-screenshot { box-shadow: none; break-inside: avoid; }
      body { background: white; }
      .main-content { margin: 0 !important; max-width: 100% !important; }
    }
    @media (max-width: 1280px) {
      .sidebar-right { display: none; }
    }
    @media (max-width: 1024px) {
      .sidebar-left { display: none; }
    }
  </style>
</head>
<body class="bg-white min-h-screen">

  <!-- Top bar -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-10 no-print">
    <div class="px-6 py-3 flex items-center justify-between">
      <a href="/" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1.5">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        All Guides
      </a>
      <div class="flex items-center gap-3">
        <a href="/recording/{{ name }}" class="text-xs text-gray-400 hover:text-gray-600">Edit</a>
        <button onclick="window.print()" class="text-xs text-gray-400 hover:text-gray-600 flex items-center gap-1">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
          Print
        </button>
      </div>
    </div>
  </header>

  <div class="flex">

    <!-- Left sidebar: All guides -->
    <aside class="sidebar-left no-print w-64 flex-shrink-0 border-r border-gray-100 bg-gray-50">
      <div class="p-4">
        <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 px-3">Guides</h2>
        <nav class="space-y-0.5">
          {% for g in all_guides %}
          <a href="/guide/{{ g.name }}" class="guide-link {{ 'active' if g.name == name else '' }}">
            <svg class="w-4 h-4 flex-shrink-0 {{ 'text-blue-500' if g.name == name else 'text-gray-400' }}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span class="truncate">{{ g.title }}</span>
          </a>
          {% endfor %}
        </nav>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main-content flex-1 min-w-0 max-w-3xl mx-auto px-8">

      <!-- Document header -->
      <div class="pt-10 pb-8 border-b border-gray-100">
        <div class="flex items-center gap-2 mb-3">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">Guide</span>
          <span class="text-xs text-gray-400">{{ steps|length }} step{{ 's' if steps|length != 1 else '' }}</span>
        </div>
        <h1 class="text-3xl font-bold text-gray-900 tracking-tight leading-tight">{{ title }}</h1>
      </div>

      <!-- Preamble -->
      {% if preamble %}
      <div class="py-8 border-b border-gray-100">
        <div class="rich-text text-gray-700 text-sm leading-relaxed">{{ preamble | safe }}</div>
      </div>
      {% endif %}

      <!-- Steps -->
      <div class="py-10">
        {% for step in steps %}
        <div class="doc-step relative {% if not loop.last %}pb-12{% endif %}" id="step-{{ loop.index }}">
          <div class="flex gap-5">
            <!-- Timeline -->
            <div class="relative flex-shrink-0">
              <div class="step-node">{{ loop.index }}</div>
              {% if not loop.last %}
              <div class="step-connector"></div>
              {% endif %}
            </div>

            <!-- Content -->
            <div class="flex-1 min-w-0 pt-1.5">
              {% if step.details and step.details.title %}
              <h3 class="text-lg font-semibold text-gray-900 mb-1">{{ step.details.title }}</h3>
              <p class="text-xs text-gray-400 mb-2">
                {{ step.action_type | replace('_', ' ') | title }}{% if step.application and step.application.name %} in {{ step.application.name }}{% endif %}
              </p>
              {% else %}
              <p class="text-sm text-gray-500 mb-2">
                {{ step.action_type | replace('_', ' ') | title }}{% if step.application and step.application.name %} in {{ step.application.name }}{% endif %}
              </p>
              {% endif %}
              {% if step.details and step.details.description %}
              <div class="rich-text text-gray-800 text-sm mb-4 leading-relaxed">{{ step.details.description | safe }}</div>
              {% endif %}

              <div class="screenshot-wrapper">
                <img src="/recordings/{{ name }}/{{ step.screenshot }}"
                     alt="Step {{ loop.index }}"
                     class="doc-screenshot w-full h-auto"
                     loading="lazy"
                     {% if step.position %}data-click-x="{{ step.position.x }}" data-click-y="{{ step.position.y }}"{% endif %}>
                {% if step.position %}
                <div class="click-highlight" style="display:none;" data-click></div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Footer -->
      <div class="py-8 border-t border-gray-100 text-center no-print">
        <p class="text-xs text-gray-400">Generated from a recorded session</p>
      </div>
    </main>

    <!-- Right sidebar: In this guide -->
    <aside class="sidebar-right no-print w-56 flex-shrink-0 border-l border-gray-100">
      <div class="p-4">
        <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 px-3">In this guide</h2>
        <nav id="toc" class="space-y-0.5">
          {% for step in steps %}
          <a href="#step-{{ loop.index }}" class="toc-link" data-step="{{ loop.index }}">
            <span class="text-xs text-gray-400 font-mono mr-1">{{ loop.index }}.</span>
            {% if step.details and step.details.title %}
              {{ step.details.title | truncate(50) }}
            {% elif step.details and step.details.description %}
              {{ step.details.description | striptags | truncate(50) }}
            {% else %}
              {{ step.action_type | replace('_', ' ') | title }}{% if step.application and step.application.name %} in {{ step.application.name }}{% endif %}
            {% endif %}
          </a>
          {% endfor %}
        </nav>
      </div>
    </aside>

  </div>

  <script>
    // Highlight TOC link based on scroll position
    const tocLinks = document.querySelectorAll('#toc .toc-link');
    const stepEls = document.querySelectorAll('.doc-step');

    function updateActiveToc() {
      let current = '';
      stepEls.forEach(el => {
        const rect = el.getBoundingClientRect();
        if (rect.top <= 100) current = el.id;
      });
      tocLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === '#' + current);
      });
    }

    window.addEventListener('scroll', updateActiveToc, { passive: true });
    updateActiveToc();

    // Position click highlights after images load
    document.querySelectorAll('.screenshot-wrapper img[data-click-x]').forEach(img => {
      const place = () => {
        const highlight = img.parentElement.querySelector('[data-click]');
        if (!highlight || !img.naturalWidth) return;
        const clickX = parseFloat(img.dataset.clickX);
        const clickY = parseFloat(img.dataset.clickY);
        // Multiply by 2 to convert macOS logical points to Retina physical pixels
        const pctX = (clickX * 2 / img.naturalWidth * 100);
        const pctY = (clickY * 2 / img.naturalHeight * 100);
        highlight.style.left = pctX + '%';
        highlight.style.top = pctY + '%';
        highlight.style.display = 'block';
      };
      if (img.complete && img.naturalWidth) place();
      else img.addEventListener('load', place);
    });
  </script>
</body>
</html>
